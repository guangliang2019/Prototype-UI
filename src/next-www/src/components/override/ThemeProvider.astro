---
/** 无前端变量输出，全部靠内联 JS 防 FOUC */
---

<meta name="color-scheme" content="light dark" />

{/* 提前设置 data-theme，避免 FOUC */}
<script is:inline>
  (function () {
    const KEY = 'starlight-theme';
    const mql = window.matchMedia('(prefers-color-scheme: light)');
    const getSystem = () => (mql.matches ? 'light' : 'dark');

    // 只保留两态：'light' | 'dark'
    const load = () => {
      const v = typeof localStorage !== 'undefined' && localStorage.getItem(KEY);
      return v === 'light' || v === 'dark' ? v : null;
    };
    const apply = (t) => {
      document.documentElement.dataset.theme = t;
      // 给 chrome/safari 一个暗色介面提示（和 meta 协同）
      document.documentElement.style.colorScheme = t;
    };

    // 初始化（若无存储，则跟随系统）
    const initial = load() || getSystem();
    apply(initial);

    // 供其它组件调用的轻量全局单例
    window.StarlightTheme = {
      get() {
        // 返回实际应用中的主题（此实现下与存储一致）
        return document.documentElement.dataset.theme === 'light' ? 'light' : 'dark';
      },
      set(theme /* 'light' | 'dark' */) {
        const t = theme === 'light' ? 'light' : 'dark';
        try { localStorage.setItem(KEY, t); } catch (e) {}
        apply(t);
        // 通知所有 UI 控件同步自身外观
        document.dispatchEvent(new CustomEvent('starlight-theme:change', { detail: { theme: t } }));
      },
      toggle() {
        this.set(this.get() === 'light' ? 'dark' : 'light');
      },
      // 让选择器控件在挂载时就能对齐当前主题/图标
      hydratePickers() {
        document.dispatchEvent(new CustomEvent('starlight-theme:hydrate'));
      },
    };

    // 如果你希望在“无用户选择时”继续跟随系统，可监听系统变更；
    // 但本版本是“两态固定选择”，一旦写入 localStorage 就不再随系统变动。
    // 如需“首次无存储时随系统自动更新”，可将下面监听打开，并加一个 flag 仅在无存储时生效。
    mql.addEventListener('change', () => {
      if (!localStorage.getItem(KEY)) {
        apply(getSystem());
        document.dispatchEvent(new CustomEvent('starlight-theme:change', { detail: { theme: getSystem() } }));
      }
    });
  })();
</script>

{/* 图标模板（与原始的两个 SVG 兼容，可直接引用类名 .light / .dark） */}
<template id="starlight-theme-icons">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
       viewBox="0 0 24 24" fill="none" stroke="currentColor"
       stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
       class="size-4.5 light">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
    <path d="M12 3l0 18"></path>
    <path d="M12 9l4.65 -4.65"></path>
    <path d="M12 14.3l7.37 -7.37"></path>
    <path d="M12 19.6l8.85 -8.85"></path>
  </svg>
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
       viewBox="0 0 24 24" fill="none" stroke="currentColor"
       stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
       class="size-4.5 dark rotate-180">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
    <path d="M12 3l0 18"></path>
    <path d="M12 9l4.65 -4.65"></path>
    <path d="M12 14.3l7.37 -7.37"></path>
    <path d="M12 19.6l8.85 -8.85"></path>
  </svg>
</template>
